#!/bin/bash
# ┌───────────────────────────────────────────--------────┐
# │ Type / Version : bash / 1.0.0.0-live                  │
# │ Author         : Mark Hamilton │ Co-Pilot AI assisted │
# │ Script Purpose : Linux Desktop Launcher               │
# │ Package        : toolbox                              │
# └───────────────────────────────────────────────------──┘
# Usage:
#   tool-ldp
# Description:
#   Launches a Linux desktop session with X11 rendering, D-Bus setup,
#   ICE socket fix, and session lock cleanup. Designed for local use
#   in authorized environments. Logs all actions for traceability.
# End Help

LOGFILE="$HOME/Documents/desktop-launch.log"
exec >> "$LOGFILE" 2>&1
echo "-----------------------------"
echo "Launch started: $(date)"

# Resolve DISPLAY
export DISPLAY=$(ip route | awk '/^default/ {print $3}'):0.0
echo "DISPLAY set to: $DISPLAY"

# X11 rendering options
export LIBGL_ALWAYS_INDIRECT=1
export GDK_BACKEND=x11
export QT_QPA_PLATFORM=xcb
echo "X11 backend variables set"

# Check and start D-Bus session
if [ ! -S /run/user/$(id -u)/bus ]; then
    eval "$(dbus-launch --sh-syntax)"
    echo "Started new D-Bus session with PID: $DBUS_SESSION_BUS_PID"
else
    echo "D-Bus session already active"
fi

# Fix ICE socket
if [ -d /tmp/.ICE-unix ]; then
    sudo chown root:root /tmp/.ICE-unix && echo "Fixed ICE ownership"
    sudo chmod 1777 /tmp/.ICE-unix && echo "Set ICE permissions"
else
    echo "/tmp/.ICE-unix not found"
fi

# Remove old session locks
rm -f ~/.cache/sessions/xfce4-session-*.lock 2>/dev/null && echo "Cleared xfce4 session lock"

# Start window manager if needed
if ! pgrep -x "xfwm4" > /dev/null; then
    nohup xfwm4 --replace >/dev/null 2>&1 &
    echo "Started xfwm4"
else
    echo "xfwm4 already running"
fi

# Export Xauthority
export XAUTHORITY=$HOME/.Xauthority
echo "XAUTHORITY set to: $XAUTHORITY"

# Start full session
nohup startxfce4 >/dev/null 2>&1 &
disown
echo "Launched startxfce4 in background"

echo "Launch completed: $(date)"
